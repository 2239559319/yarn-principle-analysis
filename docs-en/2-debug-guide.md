# chapter 2 debug guide

> The article will publish on [medium](https://medium.com/@w2239559319/list/yarn-principle-analysis-ebdbd4b1ab25)

> The source code of the book is located at [github](https://github.com/2239559319/yarn-principle-analysis)

In the previous chapter, we have packaged the `yarn` product with sourcemap. This chapter will initially configure the debugging environment.

## Debugging with vscode

Create a new folder as the debug folder, which is where the `yarn` command is actually run. Create a `launch.json` of `vscode` in the `yarn` source code folder. Select `node -> launch` and set the `cwd` option to the path of the newly created debug folder.

The complete configuration file is as follows.

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "debug yarn version", // debug yarn --version command
      "skipFiles": ["<node_internals>/**"],
      "console": "internalConsole",
      "outFiles": ["${workspaceFolder}/**/*.(m|c|)js", "!**/node_modules/**"],
      "program": "${workspaceFolder}/mybuild/cli/index.js",
      "cwd": "${workspaceFolder}/../yarn-source-dev", // This setting is the path of the newly created debug folder. Both relative and absolute paths are acceptable.
      "args": ["--version"]
    }
  ]
}
```

Breakpoint to `src/cli/index.js` for debugging, and find that the breakpoint can be hit.

![vscode debug](https://unpkg.com/xiaochuan-static-dev@0.0.3/dist/24ad19a882f6d7c4.png)

In the following debugging, we can debug each command by adding `configurations` in `launch.json`. Just change the `args` in the example to the command you want to debug.

## node flame graph

### Generate node flame graph

Generate a flame graph of the `nodejs` running to clearly see the execution stack and the order of calls.

Add the default package in the debug folder and delete `node_modules`.

```bash
yarn init -y

yarn add react@18   # 18 must be used here, because react18 has dependencies to better analyze the installation process

rm -rf node_modules
```

Find the location of the packaged entry js file, the path relative to the yarn source folder is `./mybuild/cli/index.js`, copy the absolute path. Run the following code, and a cpuprofile file will be generated in the debug folder. This is the flame graph file, which can be opened with the browser's debugging tool.

```bash
node --cpu-prof --cpu-prof-interval=1 /yarn-dev/yarn/lib/cli/index.js install
```

Image of `cpuprofile` file generated after running

![generated cpuprofile file](https://unpkg.com/xiaochuan-static-dev@0.0.4/dist/a95adf7aeacbcb13.png)

### View the flame graph

Go to `Open dedicated DevTools for Node` in the browser `chrome://inspect/`.

![chrome://inspect](https://unpkg.com/xiaochuan-static-dev@0.0.4/dist/f4a11aa18da67739.png)

Select `performance` and the Upload File button.

![Upload File](https://unpkg.com/xiaochuan-static-dev@0.0.4/dist/11890d221043fc72.png)

Select the cpuprofile file you just generated in the file selection, and you can see the display of the complete call stack information.

> The author uses wsl here, so the files below are not mapped to the source code. The source code folder should be `src`. Because wsl is used here, the `sourcemap` mapping is wrong and the packaged folder `mybuild` is still displayed. In fact, using `windows` or `linux` `mac` can successfully map to the source code. It doesn't matter here because the function names in the source code and the packaged code are basically unchanged, so you can still use it.

![selected file](https://unpkg.com/xiaochuan-static-dev@0.0.4/dist/cdfa0f0e06be932c.png)

## Summarize

This chapter introduces how to use vscode to debug the source code of yarn, and how to use chrome's debugging tool to analyze the flame graph generated by the yarn command. These two methods will be used for analysis and debugging in the following debugging. vscode mainly uses breakpoints for debugging, which is convenient for observing the variables and logic of each step, while the flame graph is convenient for observing the overall running steps and running rules of the command.

author: [xiaochuan](https://github.com/2239559319)

date: 2024.12.26
